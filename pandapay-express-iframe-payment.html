<!DOCTYPE html>
<html>

<link href="https://express.pandapay.io/patagonia/pp-express.css" rel="stylesheet" type="text/css">
<link href="https://express.pandapay.io/patagonia/normalize.css" rel="stylesheet" type="text/css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://d2t45z63lq9zlh.cloudfront.net/panda-v0.0.5.min.js"></script>
<div class="ppContainer">
  <span class="back" style="position: absolute; top: 5vw; left: 5vw;">
    <svg width="16px" height="16px" viewBox="0 0 11 17" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
      <defs></defs>
      <g id="Styles" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" opacity="0.800000012">
          <g id="Icons" transform="translate(-164.000000, -142.000000)" fill="#000000">
              <g id="icons" transform="translate(75.000000, 58.000000)">
                  <g id="row5" transform="translate(0.000000, 83.477702)">
                      <g id="chevron-left" transform="translate(89.150943, 0.000000)">
                          <path d="M10.3377677,15.1814402 L8.82908285,16.690125 C8.74967839,16.7695295 8.67027392,16.7695295 8.59086945,16.690125 L0.809231738,8.82908285 C0.729827271,8.74967839 0.729827271,8.67027392 0.809231738,8.59086945 L8.59086945,0.809231738 C8.67027392,0.729827271 8.74967839,0.729827271 8.82908285,0.809231738 L10.3377677,2.3179166 C10.4171722,2.39732107 10.4171722,2.47672553 10.3377677,2.55613 L4.14421933,8.74967839 L10.3377677,14.9432268 C10.4171722,15.0226312 10.4171722,15.1020357 10.3377677,15.1814402 L10.3377677,15.1814402 Z" id="back-arrow"></path>
                      </g>
                  </g>
              </g>
          </g>
      </g>
  </svg>
  </span>
  <div class="ppHeader">
    <span id="granteeName" class="granteeName" style="font-size:20px; line-height:28px;">[Grantee Name]</span>
  </div>
  <span class="close" style="position: absolute; top: 5vw; right: 5vw;">
    <svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
      <defs></defs>
      <g id="Symbols" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
          <g id="header" transform="translate(-400.000000, -8.000000)" fill="#000000">
              <g id="x-close">
                  <path d="M410.052877,15.962675 L415.92535,21.8351477 C416.024883,21.9346812 416.024883,22.0342146 415.92535,22.1337481 L414.034215,23.9253499 C413.934681,24.0248834 413.835148,24.0248834 413.735614,23.9253499 L407.962675,18.0528771 L402.090202,23.9253499 L401.891135,23.9253499 L400,22.0342146 L400,21.8351477 L405.872473,15.962675 L400,10.0902022 L400,9.8911353 L401.891135,8 L402.090202,8 L407.962675,13.8724728 L413.835148,8 L414.034215,8 L415.92535,9.8911353 L415.92535,10.0902022 L410.052877,15.962675 L410.052877,15.962675 Z"></path>
              </g>
          </g>
      </g>
  </svg>
  </span>
  <hr>
  <div class="ppLeftText ppModalContent">
    <p style="font-family: AvenirNextLTPro-demi; font-size: 16px;">Payment Information
      <span style="float: right; font-family: AvenirNextLTPro-Bold; font-size: 14px;">$
        <span id="amount">0</span>
      </span>
    </p>
    <div>
      <form id="panda_cc_form">
        <input type="email" class="form-control" id="receipt_email" placeholder=" Email" required>
        <br>
        <div style="padding-top: 8px" class="ppRegFont">
          <input id="emailUpdates" type="checkbox" />
          <label for="emailUpdates"></label>
          <span class="checkboxLabel">Sign up for email updates</span>
        </div>
        <div class="row" style="padding-top: 20px;">
          <div class="col" style="width: 50%">
            <input type="text" class="form-control" style="border-right: none;" id="firstName" data-panda="first_name" placeholder="First Name" required>
          </div>
          <div class="col" style="width: 50%">
            <input type="text" class="form-control" id="lastName" data-panda="last_name" placeholder="Last Name" required>
          </div>
        </div>
        <br>
        <div class="row" style="padding-top: 30px">
          <div class="col" style="width: 55%">
            <input type="tel" class="form-control creditCardText" id="cardNumber" style="border-right: none;" data-panda="credit_card" maxlength="19" placeholder="Credit Card Number"
            required>
          </div>
          <div class="col" style="width: 25%;">
            <input type="tel" class="form-control expirationDate" id="expiration" style="border-right: none;" data-panda="expiration" placeholder="MM/YYYY" maxlength="7" required>
          </div>
          <div class="col" style="width: 20%">
            <input type="number"  pattern="[0-9]*" class="form-control" data-panda="cvv" placeholder="CVV" required>
          </div>
        </div>
        <br/>
        <span id="errorText" class="ppDonationDetails" style="font-family: AvenirNextLTPro-medium; font-size: 10px; padding-top: 10px; text-align: center;"></span>
        <div id="tokenize" style="text-align: center;">
          <button class="orange btn" id="Tbutton"  style="margin-top: 30px;" type="submit">
            <span id="buttonText">Donate</span>
          </button>
        </div>
      </form>
      <br>
      <p class="finePrint">This platform uses PandaPay to securely process and disburse your charitable donations.
        <a class="infoLink" target="_blank" href="https://www.pandapay.io/poweredby">Click here</a> for more about how it works and the terms of your donation.</p>
    </div>
  </div>
</div>

<script src="https://express.pandapay.io/patagonia/pp-express.js"></script>

<script>

  document.getElementById("firstName").value = ppFirstName;
  document.getElementById("lastName").value = ppLastName;
  // Call Panda.init() with your Panda Publishable Key and the DOM id of the
  // credit card-related form element
  Panda.init('pk_test_iuMlvLlJE-QR9kE49ZFSOw', 'panda_cc_form');
  Panda.on('success', function (cardToken) {
    document.getElementById("expiration").className = "form-control";
    document.getElementById("cardNumber").className = "form-control";
    document.getElementById("buttonText").innerHTML = "Processing";
    document.getElementById("Tbutton").disabled = true;
    var email = document.getElementById("receipt_email").value;
    localStorage.setItem('pandapayReceiptEmail', email);
    var cardType = cc_brand_id(document.getElementById("cardNumber").value);
    localStorage.setItem('pandapayCardType', cardType);
    var lastFour = document.getElementById("cardNumber").value.slice(-4);
    localStorage.setItem('pandapayLastFour', lastFour);

    if (document.getElementById("emailUpdates").checked == false) {
      var platformCustomField = "0"
    } else {
      var platformCustomField = "1"
    }
    var url = "https://expressapi.pandapay.io/donation?"
    url = url + "source=" + cardToken
    url = url + "&receipt_email=" + email
    url = url + "&amount=" + (ppAmount * 100)
    url = url + "&currency=usd&destination=" + ppEin
    url = url + "&id=patagonia_paw_test"
    url = url + "&firstName=" + document.getElementById("firstName").value
    url = url + "&lastName=" + document.getElementById("lastName").value
    url = url + "&donor_cover_fees=" + localStorage.getItem('pandapayDonorCoverFees')
    url = url + "&platform_custom_field=" + platformCustomField
    $.ajax({
      type: "POST",
      url: url,
      contentType: "application/json;",
      dataType: "json",
      crossDomain: true,
      success: function (data) {
        localStorage.setItem('pandapayDonationAmount', data["charge_amount"]);
        successfulTransaction();
      },
      error: function (xhr, status, error) {
        errorHandler(error)
        document.getElementById("buttonText").innerHTML = "Donate";
        document.getElementById("Tbutton").disabled = false;
      }
    });
  });

  Panda.on('error', function (errors) {
        errorHandler(JSON.stringify(errors));
  });

  $('.creditCardText').keyup(function () {
    var foo = $(this).val().split(" ").join("");
    foo =  foo.split("-").join(""); // remove hyphens
    if (foo.length > 0) {
      foo = foo.match(new RegExp('.{1,4}', 'g')).join(" ");
    }
    $(this).val(foo);
   });

   $('.expirationDate').keyup(function (e) {
    if(e.keyCode == 46) {
    }else if (e.keyCode == 8) {
    } else {
    var foo = $(this).val().split(" ").join("");
    // remove slash
    if (foo.length >= 2) {
    foo =  foo.split("/").join(""); 
    foo = foo.substr(0,2)+"/"+foo.substr(2);
    }
    $(this).val(foo);
  }
   });


  function getDonationAmount() {
    ppAmount = localStorage.getItem('pandapayDonationAmount');
    if (localStorage.getItem('pandapayDonorCoverFees') == "true") {
      return parseFloat(roundTo(ppAmount * 1.039 + .30, 2)).toFixed(2);
    } else {
      return parseFloat((ppAmount / 100) * 100).toFixed(2);
    }
  }
  document.getElementById("amount").innerHTML = getDonationAmount();

  var backButton = document.getElementsByClassName("back")[0];
  backButton.onclick = function () {
    window.location = 'https://express.pandapay.io/patagonia/pandapay-express-iframe.html?charityName=' + getAllUrlParams().charityName + '&firstName=' + getAllUrlParams().firstName + '&lastName=' + getAllUrlParams().lastName + '&charityEIN=' + getAllUrlParams().charityEIN + '&patagoniaUserID=' + getAllUrlParams().patagoniaUserID + '&cyberGrantsID=' + getAllUrlParams().cyberGrantsID + '&issues=' + getAllUrlParams().issues + '&wordpressID=' + getAllUrlParams().wordpressID;;
  };

  function cc_brand_id(cur_val) {
    var sel_brand;

    //JCB
    jcb_regex = new RegExp('^(?:2131|1800|35)[0-9]{0,}$'); //2131, 1800, 35 (3528-3589)
    // American Express
    amex_regex = new RegExp('^3[47][0-9]{0,}$'); //34, 37
    // Diners Club
    diners_regex = new RegExp('^3(?:0[0-59]{1}|[689])[0-9]{0,}$'); //300-305, 309, 36, 38-39
    // Visa
    visa_regex = new RegExp('^4[0-9]{0,}$'); //4
    // MasterCard
    mastercard_regex = new RegExp('^(5[1-5]|222[1-9]|22[3-9]|2[3-6]|27[01]|2720)[0-9]{0,}$'); //2221-2720, 51-55
    maestro_regex = new RegExp('^(5[06789]|6)[0-9]{0,}$'); //always growing in the range: 60-69, started with / not something else, but starting 5 must be encoded as mastercard anyway
    //Discover
    discover_regex = new RegExp('^(6011|65|64[4-9]|62212[6-9]|6221[3-9]|622[2-8]|6229[01]|62292[0-5])[0-9]{0,}$');
    ////6011, 622126-622925, 644-649, 65
    cur_val = cur_val.replace(/\D/g, '');
    if (cur_val.match(jcb_regex)) {
      sel_brand = "JCB";
    } else if (cur_val.match(amex_regex)) {
      sel_brand = "AMEX";
    } else if (cur_val.match(diners_regex)) {
      sel_brand = "Diners Club";
    } else if (cur_val.match(visa_regex)) {
      sel_brand = "VISA";
    } else if (cur_val.match(mastercard_regex)) {
      sel_brand = "MasterCard";
    } else if (cur_val.match(discover_regex)) {
      sel_brand = "Discover";
    } else if (cur_val.match(maestro_regex)) {
      if (cur_val[0] == '5') { //started 5 must be mastercard
        sel_brand = "MasterCard";
      } else {
        sel_brand = "Maestro"; //maestro is all 60-69 which is not something else, thats why this condition in the end
      }
    } else {
      sel_brand = "Card";
    }

    return sel_brand;
  }

  function errorHandler(error) {
    if (error.includes("Year is invalid") ) {
      document.getElementById("expiration").style.border = "1px solid #FA4616";
    } else {
      document.getElementById("expiration").style.border = "1px solid #CCCCCC";
      document.getElementById("expiration").style.borderRight = "none";
    };

    if (error.includes("Number is invalid") ) {
      document.getElementById("cardNumber").style.border = "1px solid #FA4616";
    } else if (error.includes("Card type is invalid") ) {
      document.getElementById("cardNumber").style.border = "1px solid #FA4616";
    } else {
      document.getElementById("cardNumber").style.border = "1px solid #CCCCCC";
      document.getElementById("cardNumber").style.borderRight = "none";
    };

    document.getElementById("errorText").innerHTML = 'There was an issue processing your donation, please verify your information and try again.';
  }

  function roundTo(n, digits) {
     if (digits === undefined) {
       digits = 0;
     }

     var multiplicator = Math.pow(10, digits);
     n = parseFloat((n * multiplicator).toFixed(11));
     var test =(Math.round(n) / multiplicator);
     return +(test.toFixed(digits));
   }
  
   var fields = {};
   fields.clientId = localStorage.getItem('client_id');
    ga('create', 'UA-104969319-1', 'auto', fields);
    ga('set', 'location', localStorage.getItem('locationURL'));
    ga('set', 'userId', decodeURI(getAllUrlParams().patagoniaUserID));
    ga('set', 'dimension1', decodeURI(getAllUrlParams().cyberGrantsID));
    ga('set', 'dimension2', 'ngo');
    ga('set', 'dimension3', decodeURI(getAllUrlParams().issues));
    ga('set', 'dimension4', decodeURI(getAllUrlParams().wordpressID));
    ga('send', {
        hitType: 'event',
        eventCategory: 'Donation',
        eventAction: 'Step',
        eventLabel: 'Step 2'
      });
</script>

</html>